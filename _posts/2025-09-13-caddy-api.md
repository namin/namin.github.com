---
layout: post
title: caddy-api for an HTTPS-ready one-user host machine
---

I’ve long been a user of nginx with certbot, this is how I productize [io.livecode.ch](https://io.livecode.ch), which DigitalOcean graciously hosts. The setup instructions for dev and prod are in the open-source repo: [https://github.com/namin/io.livecode.ch](https://github.com/namin/io.livecode.ch).

However, I found that I can get a more convenient setup using caddy, rather than nginx. Specifically, I use the variant caddy-api, where the whole hosting for one machine and all its multiple domains can be configured with one intuitive JSON file. I have used it on both macOS on a Mac Studio with a public IP address and on DigitalOcean on an Ubuntu virtual machine. Caddy feels lightweight and comes out of the box with HTTPS support.

Caddy: [https://caddyserver.com/](https://caddyserver.com/).

The Caddy server is very portable, and there could be specific instructions for your machine. Just make sure you enable `caddy-api`.

One macOS, I install with: `brew install caddy`.
See [https://formulae.brew.sh/formula/caddy](https://formulae.brew.sh/formula/caddy).
However, to get it setup for caddy-api rather than caddy, I had to make this tweak to `/opt/homebrew/Cellar/caddy/2.10.2/homebrew.mxcl.caddy.plist`

            <array>
                    <string>/opt/homebrew/opt/caddy/bin/caddy</string>
                    <string>run</string>
                    <string>--resume</string>
            </array>

Your filepath may vary. The key is to run with `--resume` instead of the caddy configuration file.

On Ubuntu, the installation steps are as follows, to make sure caddy-api the is the program enabled.

    apt install caddy
    systemctl disable caddy
    systemctl enable caddy-api
    systemctl stop caddy
    systemctl start caddy-api

From now on, the instructions for configuration are the same on macOS and Ubuntu.

Create a configuration file `caddy.json` (more below). And then, each time you make a change, you can configure the entire server host with:

    curl localhost:2019/load -H "Content-Type: application/json" -d @caddy.json

The configuration file `caddy.json` just accumulates all server configurations for the machine. It will look like this:

    {
      "apps": {
        "http": {
          "servers": {
            "default": {
              "listen": [":443"],
              "tls_connection_policies": [
                {
                  "match": {
                    "sni": ["project-dev.host.com"]
                  }
                },
                {
                  "match": {
                    "sni": ["project.host.com"]
                  }
                }
              ],
              "routes": [
                {
                  "match": [
                    {
                      "host": ["project-dev.host.com"],
                      "path": ["/api/*"]
                    }
                  ],
                  "handle": [
                    {
                      "handler": "reverse_proxy",
                      "upstreams": [
                        {
                          "dial": "localhost:3001"
                        }
                      ]
                    }
                  ]
                },
                {
                  "match": [
                    {
                      "host": ["project-dev.host.com"]
                    }
                  ],
                  "handle": [
                    {
                      "handler": "file_server",
                      "root": "/var/www/project/dist-dev"
                    }
                  ]
                },
                {
                  "match": [
                    {
                      "host": ["project.host.com"],
                      "path": ["/api/*"]
                    }
                  ],
                  "handle": [
                    {
                      "handler": "reverse_proxy",
                      "upstreams": [
                        {
                          "dial": "localhost:3000"
                        }
                      ]
                    }
                  ]
                },
                {
                  "match": [
                    {
                      "host": ["project.host.com"]
                    }
                  ],
                  "handle": [
                    {
                      "handler": "file_server",
                      "root": "/var/www/project/dist"
                    }
                  ]
                }
              ]
            }
          }
        }
      }
    }

I am showing example of reverse proxies via a port, and of static serving. This is ideal for React app frontend (built with `npm run build`) and a Typescript or Python backend. So it’s fairly intuitive and composable, if a bit verbose. Caddy also supports other formats, some more concise.

I also use the node utility pm2 to easily start processes in a portable way, although on Ubuntu it might be better to use startup services. But pm2 can be configured for automatic start too, so it’s a lightweight solution to running the services.

My only issue with this setup is that I need a lot of ports opened for the reverse proxies. Hard to keep track and make sure they don’t collide. But they are all documented in this one JSON file. I just mention this because this is different from the way services are configured through sockets on Unix, but is closer to a dev setup.

